# 3.1 研究基于特征的加密算法

## 概述

在本项目中，基于特征的加密算法是连接物理层特征与链路层认证的"中间引擎"。其核心作用有三点：

1. 把可测但含噪的设备/信道特征，稳定地映射为高熵比特串，供后续作为身份根使用；
2. 从该比特串中派生链路层所需的两类密钥：一类用于计算接入认证标签（特征密钥），一类用于保护后续数据面会话（会话密钥）；
3. 将密钥与MAC地址、时间窗等上下文强绑定，使同一设备在不同时间窗得到不同密钥，从根上抵御重放、克隆和长期跟踪。

无论3.3.2中选择"基于射频特征的快速认证模式"还是"基于特征密钥的强认证模式"，都可以在链路层通过统一接口调用"给定特征 → 输出特征密钥和会话密钥"的功能。

## 威胁模型

在威胁模型上，假定攻击者能够：

- 监听和重放历史报文
- 克隆或伪造 MAC 地址
- 在近场尝试模仿合法设备的射频指纹或信道形态
- 了解算法全部细节

但攻击者无法在同一时间窗内获得与合法设备完全一致的物理特征。

算法设计需要在这一前提下实现：

1. 合法设备在噪声、衰落和硬件漂移存在时，仍能在同一时间窗内高概率重复生成同一密钥；
2. 派生出的密钥与srcMAC/dstMAC、域标识、时间窗epoch等强绑定，具备天然的抗重放和抗克隆能力；
3. 即便攻击者完全知晓算法细节，也难以从观测到的报文和标签中反推出可用的特征信息或长期标识。

## 1. 输入输出与统一接口设计

为了保持算法结构简洁、接口清晰，本项目对"特征→密钥"模块定义统一接口：

### 输入参数

- **物理层提供的特征向量X**：可以是经预处理的信道状态信息(Channel State Information)特征，也可以是射频指纹(Radio Frequency Fingerprint)特征
- **随机数 nonce**：由验证端挑战或本端TRNG生成
- **上下文信息**：
  - srcMAC：源MAC地址
  - dstMAC：目标MAC地址
  - dom：域标识
  - ver：算法版本
  - epoch：时间窗编号
  - Ci：哈希链计数

### 输出参数

- **稳定的高熵特征串S**（如 256 bit）
- **当前时间窗的一次性随机扰动值L**：`L = Trunc₂₅₆(BLAKE3(epoch‖nonce))`，由时间窗 + 随机数决定
- **特征密钥K**：`K = F(S, L, dom, srcMAC, dstMAC, ver)`，用于接入认证标签计算
- **会话密钥Ks**：`Ks = G(K, epoch, Ci)`，用于数据面加密/完整性保护
- **轻量一致性摘要digest**：记录特征选取掩码、门限配置和算法版本，用于两端检查配置一致性，不参与密钥派生、也无法反推出原始特征

对上层而言，只需看到：给我X和上下文，我就能得到 S、K、Ks 三类量，供 3.3.2 和 3.3.3 调用。

## 2. 算法总体思路与技术支撑

本项目采用轻量的"特征→密钥"流水线，主要由以下几个步骤构成：

### 2.1 特征预处理与规整

- **对 CSI 特征**：进行频偏/时延/相位对齐，并在子载波上做简单的差分或主成分变换，压缩维度、降低相关性
- **对射频指纹特征**：进行归一化、去直流、简单滤波，消除量纲和明显噪声

这些操作都可以用线性变换和简单统计量实现，计算复杂度很低。

### 2.2 稳健量化与投票

- 按维度设置上下双门限，把连续特征映射为 0/1/擦除三值
- 在一个短时间窗内采集多帧特征，通过多数投票得到最终比特串 r

该步骤的作用是：在衰落和测量噪声下，让合法设备多次测到的比特模式尽量一致，而攻击者即便近场模仿也难以精确复制。

### 2.3 纠错与模糊提取

在比特串r上套用码偏移式模糊提取器（code-offset fuzzy extractor），结合BCH等成熟纠错码，把含噪比特修正为稳定的特征串S。

- 注册阶段生成少量辅助数据（helper data）
- 仅在本域验证端安全存储，不在链路中明文传播
- 避免对r的可逆泄露

该部分直接复用现有密码学理论和工程实践，能够在给定误码率下保证S的稳定重构。

### 2.4 上下文绑定与密钥派生

- 使用BLAKE3等通用哈希将当前时间窗与 nonce 组合成随机扰动值L
- 使用HKDF等标准密钥派生函数，以S‖L作为输入，在salt和info字段中绑定dom, srcMAC, dstMAC, ver, epoch, Ci等上下文，生成特征密钥K和会话密钥Ks

通过这种方式，同一设备在不同时间窗、不同会话中得到的密钥均不相同，且离开对应上下文后无法重放使用。

整个流程仅依赖加减乘除、简单逻辑运算和标准哈希/HKDF原语，适合在边缘设备或轻量加密模块中实现，符合"算法简洁、计算高效"的项目要求。

## 3. 算法流程细节（四步）

### 步骤一：特征预处理与规整

在指定TDD测量窗内采集M=6帧特征样本。根据特征来源不同，本项目支持两类输入路径：

#### 路径一：信道状态信息（CSI）路径

以物理层导频估计得到的信道状态信息H[k]为输入，经频偏/时延/相位校正与差分变换得到实值特征向量。

若选择信道状态信息(CSI)模式：

1. 先完成频偏/时延/相位对齐
2. 从个子载波中选取高SNR子集形成H[k]
3. 计算平均幅度
4. 构造幅度差分与相位差分
5. 拼接得实向量Z

#### 路径二：射频指纹（RFF）路径

以物理层估计的发射机射频参数（如CFO、SCO、I/Q 失衡等）为输入，经归一化和维度规整得到特征向量。

若采用射频指纹（RFF）模式，则对每帧射频估计量做标准化。

### 步骤二：稳健量化与多帧投票

对每个维度d：

1. 计算M帧统计量
2. 设置双门限（上限、下限）
3. 将每帧取值量化为三值（0/1/擦除）
4. 对M帧投票得最终比特
5. 按维度次序拼接原始比特串r（目标 bit；若不足则按"SNR 高、相关低"的优先级补位）

### 步骤三：纠错 + 模糊提取（码偏移 FE）

采用码偏移式模糊提取器稳定化：

1. 以BCH参数计算块数J
2. 随机取并分块映射为消息
3. 编码得码字
4. 生成辅助串
5. 拼接P

注册期仅将P安全写入验证侧，本端仅保留一致性配置（掩码、门限表哈希）。

### 步骤四：上下文绑定 + 密钥派生

计算当前时间窗的一次性随机扰动值：

```
L = Trunc₂₅₆(BLAKE3(epoch‖nonce))
```

派生特征密钥：

```
K = HKDF-Expand(
    PRK = HKDF-Extract(salt=dom, IKM=S‖L),
    info = ver‖srcMAC‖dstMAC‖epoch,
    L = 32
)
```

派生会话密钥：

```
Ks = HKDF-Expand(
    PRK = K,
    info = "SessionKey"‖epoch‖Ci,
    L = 32
)
```

为保证跨实现一致，固定子载波/维度选择掩码（如按SNR选取前m个），并生成一致性摘要：

```
digest = Trunc₆₄(BLAKE3(mask‖θ_L‖θ_H‖algID‖ver))
```

随配置一同保存。

## 4. 输出参数说明

经过特征加密算法处理后，输出以下参数：

- **S**：稳定高熵特征串，只作为"密钥种子"
- **L**：当前时间窗的随机扰动值
- **K**：特征密钥（给3.3.2用来算认证标签/伪名）
- **Ks**：会话密钥（给 3.3.2/3.3.3用来保护后续数据面、轮换）
- **digest**：特征选取掩码/门限/版本的摘要，用来在认证时确认双方用的是同一套配置

## 5. 与认证方法的衔接

基于特征的加密算法作为链路层接入认证的"密钥引擎"，其输出将直接供 3.3.2 节的两种认证模式调用：

### 在基于射频特征的快速认证模式下

链路层主要利用物理层给出的RFF判定结果（通过/不通过）做快速放行或拒绝，必要时可调用本节算法获得会话密钥 Ks，用于后续数据面加密。

### 在基于特征密钥的强认证模式下

终端首先通过本节算法从特征向量X和上下文信息生成特征密钥K和会话密钥Ks，并在首个接入报文中利用K计算认证标签（如 Tag = MAC(K, 报文头‖nonce‖epoch‖序号)）和伪名标识。

验证端根据同一时间窗内的特征和上下文重算K*，对比认证标签一致性，并在digest校验通过的前提下发放准入令牌，后续数据面则采用 Ks 进行保护。
